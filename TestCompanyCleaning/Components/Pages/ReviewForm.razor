@page "/review/add"
@page "/review/{Id:int}"

@inject IDataService data
@inject NavigationManager navigate

@if (NotFound)
{
    <div class="alert alert-danger m-3">
        Заявка с ID @Id не найдена
    </div>
    <a class="btn btn-secondary m-3" href="/">Вернуться на главную</a>
}

else if (RequestItem != null)
{
    <EditForm Model="RequestItem" FormName="RequestForm" OnValidSubmit="ValidSubmit">
        <DataAnnotationsValidator />
        @* <ValidationSummary /> *@

        <h2>Заявка на клининг</h2>
        <InputNumber @bind-Value="RequestItem.Id" hidden />

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">ФИО</label>
            <InputText @bind-Value="RequestItem.FullName" class="form-control" readonly />
            <ValidationMessage For="() => RequestItem.FullName" />
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Телефон</label>
            <InputText @bind-Value="RequestItem.PhoneNumber" class="form-control" readonly
                       maxlength="11" inputmode="numeric" pattern="[0-9]*" />
            <ValidationMessage For="() => RequestItem.PhoneNumber" />
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Офис</label>
            <input class="form-control" value="@RequestItem.OfficeAddress" readonly />
            <InputText @bind-Value="RequestItem.OfficeAddress" hidden />
            <ValidationMessage For="() => RequestItem.OfficeAddress" />
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Кабинет</label>
            <input class="form-control" value="@RequestItem.Room" readonly />
            <InputText @bind-Value="RequestItem.Room" hidden />
            <ValidationMessage For="() => RequestItem.Room" />
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Мойка окон</label>
            <span class="form-control bg-light">@((RequestItem.WindowWashing ? "Да" : "Нет"))</span>
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Влажная уборка</label>
            <span class="form-control bg-light">@((RequestItem.WindowWashing ? "Да" : "Нет"))</span>
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Чистка ковров</label>
            <span class="form-control bg-light">@((RequestItem.WindowWashing ? "Да" : "Нет"))</span>
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Дезинфекция</label>
            <span class="form-control bg-light">@((RequestItem.WindowWashing ? "Да" : "Нет"))</span>
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Вынос мусора</label>
            <span class="form-control bg-light">@((RequestItem.WindowWashing ? "Да" : "Нет"))</span>
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Очистка офисной техники</label>
            <span class="form-control bg-light">@((RequestItem.WindowWashing ? "Да" : "Нет"))</span>
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Дата и время</label>
            <InputDate @bind-Value="RequestItem.RequestedDateTime" class="form-control" min="@MinDateString" readonly />
            <ValidationMessage For="() => RequestItem.RequestedDateTime" />
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Комментарий</label>
            <InputTextArea @bind-Value="RequestItem.Comment" class="form-control" maxlength="200" readonly />
            <ValidationMessage For="() => RequestItem.Comment" />
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Оценка</label>
            <InputSelect @bind-Value="RequestItem.Rating" class="form-control">
                <option value="">Выберите оценку</option>
                @foreach (var rating in RequestItem.AvailableRating)
                {
                    <option value="@rating">@rating</option>
                }
            </InputSelect>
            <ValidationMessage For="() => RequestItem.Rating" />
        </div>

        <div class="form-group d-flex justify-content-between m-2">
            <label class="col-form-label col-3">Комментарий к оценке</label>
            <InputTextArea @bind-Value="RequestItem.ReviewComment" class="form-control" maxlength="200" />
            <ValidationMessage For="() => RequestItem.ReviewComment" />
        </div>

        <div class="btn-group">
            <button class="btn btn-primary m-2" type="submit">Отправить</button>
            <a class="btn btn-secondary m-2" href="/">Отмена</a>
        </div>
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    RequestItem? RequestItem { get; set; }

    bool NotFound = false;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnInitializedAsync();
        if (RequestItem == null)
        {
            RequestItem = new();
            if (Id != 0)
            {
                var src = await data.GetRequestAsync(Id);

                if (src == null)
                {
                    NotFound = true;
                    return;
                }

                RequestItem = src;
            }
            else
            {
                RequestItem = new();
            }
        }
    }

    async Task ValidSubmit()
    {
        if (RequestItem!.Id != 0)
        {
            // Получаем оригинальную заявку из базы
            var originalRequest = await data.GetRequestAsync(RequestItem.Id);
            if (originalRequest != null)
            {
                // Восстанавливаем флаги услуг
                RequestItem.WindowWashing = originalRequest.WindowWashing;
                RequestItem.WetСleaning = originalRequest.WetСleaning;
                RequestItem.CarpetСleaning = originalRequest.CarpetСleaning;
                RequestItem.Disinfection = originalRequest.Disinfection;
                RequestItem.GarbageRemoval = originalRequest.GarbageRemoval;
                RequestItem.OfficeEquipmentCleaning = originalRequest.OfficeEquipmentCleaning;

                // Также можно восстановить другие важные поля:
                RequestItem.OfficeAddress = originalRequest.OfficeAddress;
                RequestItem.Room = originalRequest.Room;
                RequestItem.FullName = originalRequest.FullName;
                RequestItem.PhoneNumber = originalRequest.PhoneNumber;
                RequestItem.RequestedDateTime = originalRequest.RequestedDateTime;
                RequestItem.Comment = originalRequest.Comment;
                RequestItem.CreatedDate = originalRequest.CreatedDate;
            }
        }

        await data.SaveAsync(RequestItem!);
        navigate.NavigateTo("/");
    }

    string MinDateString => DateTime.Now.ToString("yyyy-MM-dd");
}